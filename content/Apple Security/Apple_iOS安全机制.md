# Apple iOS安全机制

![SamuelChan/20180927163537.png](http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20180927163537.png)

## 内存结构

...to be continued

## 苹果数据加密机制

iOS整个磁盘是全盘加密的,且相关的key(EMF Key,DKey,BAG1 Key)存放在**可擦除分区**

1. **解密**整个磁盘的`EMF Key`(file-system master encryption key):保存在闪存中1号扇区的可安全擦除区域(擦除后无法恢复，并且支持**远程擦除**)，该key对每台设备都是唯一，并且会在数据擦除时销毁；

2. 在磁盘之上的文件系统的内容也是加密的，在每个文件创建的时候会随机生成针对每个文件的`Per-File Key`(**加密/解密**)，通过这个`Per-File Key`对文件中的内容进行加密保护

3. 苹果又为此设计了`Class Key`(**加密/解密**)来对`Per-File Key`进行保护。苹果设计**A-F**等各个不同的保护级别的`Class Key`，每个级别分别对应了密钥生成和销毁的时机

    - 全面保护(Class A)
    数据保护最为严格的级别，系统解锁后才能够解锁解密的密钥，并且在锁定以后丢弃该密钥。

    - 未打开文件保护(Class B)
    数据保护较为严格的级别，通过密钥包中的Class Key进行协商生成公私钥，文件一但解锁后即使系统锁屏仍然可以访问，直到文件句柄被关闭。

    - 首次认证前保护(Class C)
    数据保护较为严格的级别，在系统启动时第一次输入密码时解锁解密的密钥，并且在系统关闭时丢弃密钥。

    - 无数据保护(Class D)

        没有指定数据保护，但这不意味着文件没有加密保护，对于没有设置数据保护的其他所有文件，iOS中用一个`DKey(Device Key)`(**解密**)进行保护。该Key设备唯一，并且保存在闪存的可安全擦除区域。

4. BAG1 Key用来**解密**`密钥包`

## 锁屏密码保护机制

锁屏密码(PassCode)除了防止用户进入系统桌面之外，更重要的角色就是利用密码对系统密钥包进行额外的加密保护。

用户在第一次设置锁屏密码的时候，锁屏密码会结合 **硬件加密引擎** 生成一个叫做`Passcode Key`的密钥，通过这个密钥对保存在密钥包中的各个钥匙(`Class Key`)进行加密保护。锁屏密码不会以其他加密的形式保存在设备上，用户在解锁的时候，会直接用输入的密码生成`Passcode Key`对密钥包中的`Class Key`解密，解密失败代表用户密码错误。

## 历史破解的方法

1. 早期的A4及更老的芯片(iPhone4之前的设备包括iPhone4)存在`bootrom`漏洞，通过`bootrom`中的硬件漏洞获取设备的shell然后运行暴力破解程序。 **[A4后面的芯片目前没有公开的bootrom漏洞]**

2. iOS7中存在利用外接键盘可以暴力破解密码，甚至停用的设备也可以破解的漏洞。**[该漏洞已经在iOS8中修复]**

3. iOS8的早期几个版本中存在密码尝试失败立即断电并不会增加错误计数的漏洞。**[该漏洞已经修复]**

4. 32位系统不支持Secure Enclave做硬件的计时和计数

## TouchId

> 设备已经输入过正确的解锁密码的情况下，并且设备解锁的时间在48小时之内，其实还是可以通过克隆指纹的方式对设备进行解锁

## iCloud

> FBI要求查看iOS源代码到最后苹果威胁要在iCloud中用点对点加密代替现在的Master Key方案
>
> 苹果在备份加密数据的同时，还对密钥包使用非对称密钥加密的方式加密后保存在苹果的iCloud服务器上，并且苹果拥有Master Key进行解密。

## FBI是如何破解一台运行着iOS 9的iPhone 5c

FBI要想要破解的这台手机是一台iPhone 5C并且运行着iOS 9，从硬件的角度上来说这是一台32位的设备(没有Secure Enclave)，所以我们觉得相对可能的几个方案是(第三种是可能性最高的)：

- 通过未公开的bootrom/iboot漏洞来获得系统的权限，然后通过修补内核的方式去绕过软件的错误计数来进行暴力破解密码。

- 使用未公开的暴力破解绕过错误计数的漏洞(类似曾经出现过的强制断电绕过的漏洞)

- 事先通过物理方式先对手机上闪存的数据进行克隆，**由于32位系统不支持在Secure Enclave做硬件的计时和计数**，可以通过类似USB外接键盘进行暴力猜测，每当猜测到9次左右的时候，再通过物理方式用克隆的数据对手机进行数据恢复，这样就避免了数据被擦除的尴尬。

- 通过摄像头追终嫌疑人的生活轨迹并且分析，比如摄像头刚好拍摄到嫌疑人在星巴克解锁手机，那么就可以通过图片分析的手段来判断用户输入的锁屏密码是什么。

如果这是一台64位的设备(拥有Secure Enclave)，第三方即使拥有bootrom级别的漏洞都不可能对设备进行暴力破解,除非在找到Secure Enclave的漏洞才有可能对设备进行暴力破解,目前来看这种可能性微乎其微。这种情况下也许走司法程序是个更容易的方法。



1.数据储存加密
passCode用来干嘛? 加密"密钥包”是怎么做的

touchId,faceId: 储存的是固定数据还是模式匹配? 如果是模式匹配就不能用来加密

iCloud机制(Guide比较浅显,找资料): masterKey漏洞 → 木马机,主要是由iCloud同步造成的;

本地储存还是安全的

fileSystem Key : 数据加密/验证

perFile Key: 数据加密/验证

关注廉价机型安全: 5c(32位系统),缺乏硬件层面上,防止暴力破解的芯片

2.数据传输加密

## 参考资料

[全面解析iOS加密机制](https://mp.weixin.qq.com/s?__biz=MzAwODc4NDQ2OA==&mid=2649611852&idx=1&sn=183782b8c20ee2e776418db7a8d5a241&mpshare=1&scene=1&srcid=09278cthOAX7sEduymjGfxHx#rd)